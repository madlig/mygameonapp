rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    // Optional helper: update publik hanya untuk vote duplicate request dari landing
    function isPublicVoteUpdate() {
      return
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['votes', 'updatedAt']) &&
        request.resource.data.votes is number &&
        resource.data.votes is number &&
        request.resource.data.votes == resource.data.votes + 1 &&
        request.resource.data.updatedAt is timestamp;
    }

    // =========================
    // PUBLIC COLLECTIONS
    // =========================

    // Games: publik boleh baca (landing/search), write hanya admin login
    match /games/{gameId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    // Requests:
    // - create: publik boleh submit request dari landing tanpa login
    // - read: publik boleh baca untuk cek duplikat di landing
    // - update:
    //   - admin login: full update
    //   - publik: hanya vote increment (duplicate request flow)
    // - delete: admin only
    match /requests/{reqId} {
      allow create, read: if true;
      allow update: if isSignedIn() || isPublicVoteUpdate();
      allow delete: if isSignedIn();
    }

    // =========================
    // ADMIN / PRIVATE COLLECTIONS
    // =========================

    match /genres/{genreId} {
      allow read, write: if isSignedIn();
    }

    match /emailLocations/{locId} {
      allow read, write: if isSignedIn();
    }

    match /projects/{projectId} {
      allow read, write: if isSignedIn();
    }

    match /tasks/{taskId} {
      allow read, write: if isSignedIn();
    }

    // Operational collections (pakai yang sekarang dipakai app + legacy yang sempat ada)
    match /adminShifts/{shiftId} {
      allow read, write: if isSignedIn();
    }

    match /dailyRevenues/{revId} {
      allow read, write: if isSignedIn();
    }

    match /operational_daily_recap/{docId} {
      allow read, write: if isSignedIn();
    }

    // Legacy names (aman dipertahankan agar tidak putus jika masih ada pemakaian lama)
    match /shifts/{shiftId} {
      allow read, write: if isSignedIn();
    }

    match /daily_revenues/{dateId} {
      allow read, write: if isSignedIn();
    }

    // User-scoped docs
    match /users/{userId}/{document=**} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
